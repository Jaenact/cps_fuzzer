# =====================================================
# 1. Tag Trigger Release Workflow
# 태그 푸시 시 자동 릴리즈 생성
# =====================================================
name: Release on Tag

on:
  push:
    tags:
      - "v*.*.*" # v1.0.0, v2.1.3 등

permissions:
  contents: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Tests
        run: |
          python tests/test_v2.py

      - name: Create Release Archive
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          mkdir -p dist

          # Create source archive
          zip -r dist/iptime-fuzzer-${VERSION}-src.zip . \
            -x ".git/*" \
            -x "__pycache__/*" \
            -x "*.pyc" \
            -x ".github/*" \
            -x "dist/*"

          # Create checksums
          cd dist
          sha256sum *.zip > SHA256SUMS.txt

      - name: Generate Release Notes
        id: release_notes
        run: |
          echo "## What's Changed" > RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          git log $(git describe --tags --abbrev=0 HEAD^)..HEAD --pretty=format:"- %s" >> RELEASE_NOTES.md 2>/dev/null || echo "- Initial release" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "## Checksums" >> RELEASE_NOTES.md
          echo '```' >> RELEASE_NOTES.md
          cat dist/SHA256SUMS.txt >> RELEASE_NOTES.md
          echo '```' >> RELEASE_NOTES.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/*.zip
            dist/SHA256SUMS.txt
          body_path: RELEASE_NOTES.md
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref, '-alpha') || contains(github.ref, '-beta') || contains(github.ref, '-rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
